<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aarambh Ignite </title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Merriweather:wght@700&display=swap" rel="stylesheet">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX"
     crossorigin="anonymous"></script>

    <style>
        :root {
            --primary-color: #3b82f6; --secondary-color: #60a5fa; --light-bg: #f5f7fa;
            --white-color: #ffffff; --dark-text: #1f2937; --light-text: #6b7280;
            --border-color: #e5e7eb; --shadow: 0 4px 12px rgba(0, 0, 0, 0.07);
            --shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.12); --success-color: #28a745; --danger-color: #dc3545;
        }
        body.dark-mode {
            --primary-color: #60a5fa; --secondary-color: #3b82f6; --light-bg: #111827;
            --white-color: #1f2937; --dark-text: #f9fafb; --light-text: #9ca3af;
            --border-color: #374151;
        }
        body { 
            font-family: 'Poppins', sans-serif; background-color: var(--light-bg); 
            margin: 0; padding: 0; color: var(--dark-text); padding-bottom: 80px; 
            transition: background-color 0.3s, color 0.3s;
        }
        #quiz-page { padding-bottom: 20px; }
        .page { display: none; padding: 15px; max-width: 850px; margin: 0 auto; animation: fadeIn 0.5s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #login-page, #admin-login-page, #signup-page {
            display: none; justify-content: center; align-items: flex-start;
            height: auto; min-height: 100vh; margin: 0; padding-top: 50px;
        }
        #login-page.active, #admin-login-page.active, #signup-page.active { display: flex; }
        .login-wrapper { text-align: center; width: 100%; max-width: 380px; }
        .app-logo { width: 150px; margin-bottom: 15px; }
        .app-tagline { font-size: 16px; color: var(--light-text); margin-top: 5px; margin-bottom: 30px; }
        .login-container {
            background-color: var(--white-color); padding: 35px; border-radius: 16px;
            box-shadow: var(--shadow); text-align: left;
        }
        .login-container h2 { font-weight: 700; font-size: 28px; color: var(--dark-text); margin: 0 0 8px 0; text-align: center; }
        .login-container .subtitle { text-align: center; margin-bottom: 25px; color: var(--light-text); }
        .login-container label, .admin-section label { font-weight: 600; margin-bottom: 8px; display: block; }
        .login-container input, form textarea, .admin-section input, .admin-section textarea {
            width: 100%; padding: 14px; margin-bottom: 18px; border: 1px solid var(--border-color); border-radius: 8px; 
            box-sizing: border-box; background-color: var(--light-bg); color: var(--dark-text); font-family: 'Poppins', sans-serif; font-size: 16px;
        }
        .login-container button, form button, .admin-section button {
            width: 100%; padding: 14px; background-color: var(--primary-color); color: #fff; 
            border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; margin-top: 10px;
            transition: background-color 0.3s, transform 0.2s;
        }
        .login-container button:hover, form button:hover, .admin-section button:hover { background-color: var(--secondary-color); }
        .auth-switch-link { text-align: center; margin-top: 20px; color: var(--light-text); }
        .auth-switch-link a { color: var(--primary-color); font-weight: 600; text-decoration: none; cursor: pointer; }
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .header-logo { height: 60px; }
        .welcome-text { font-size: 22px; font-weight: 700; color: var(--dark-text); text-transform: capitalize; flex-grow: 1; text-align: left; margin-left: 15px; }
        .header-actions { display: flex; align-items: center; gap: 10px; }
        .theme-toggle, .logout-btn, .profile-btn {
            width: 45px; height: 45px; background-color: var(--white-color); border: 1px solid var(--border-color);
            border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center;
        }
        .theme-toggle svg, .logout-btn svg, .profile-btn svg { width: 24px; height: 24px; fill: var(--dark-text); }
        .banner { background: var(--primary-color); color: #fff; text-align: center; padding: 40px 20px; border-radius: 16px; margin-bottom: 25px; }
        .banner p { font-size: 20px; font-weight: 600; margin: 0; }
        .banner a { color: inherit; text-decoration: none; font-size: 16px; font-weight: 500; margin-top: 10px; display: inline-block; opacity: 0.9; }
        .back-button { padding: 12px 20px; background-color: var(--secondary-color); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500; margin-top: 10px; flex: none; width: fit-content; margin-bottom: 20px; }
        h1, h2, h3 { color: var(--dark-text); text-align: center; }
        .list-container { list-style-type: none; padding: 0; }
        .list-container li { display: flex; align-items: center; background-color: var(--white-color); padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: var(--shadow); cursor: pointer; transition: background-color 0.2s, transform 0.2s; }
        .list-container li > span:first-child { flex-grow: 1; }
        .list-container:not(.answered) li:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
        .quiz-question { margin-bottom: 30px; background-color: var(--white-color); padding: 20px; border-radius: 10px; box-shadow: var(--shadow); animation: fadeIn 0.3s ease; }
        #options-container li.selected { background-color: var(--secondary-color) !important; color: white; }
        .list-container.answered li { cursor: default; }
        .question-list-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--white-color); padding: 15px; margin-bottom: 10px; border-radius: 8px; }
        .question-actions { display: flex; gap: 10px; }
        .edit-btn { background-color: #ffc107; color: #333; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer;}
        .delete-btn { background-color: var(--danger-color); border: none; border-radius: 6px; padding: 8px 12px; color: white; cursor: pointer;}
        .chapter-edit-btn { padding: 5px 10px; font-size: 14px; margin: 0 5px; flex-shrink: 0; width: auto; text-align: center; }
        .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 9999; justify-content: center; align-items: center; }
        .popup-content { background-color: var(--white-color); color: var(--dark-text); padding: 30px; border-radius: 16px; text-align: center; max-width: 350px; margin: 20px; box-shadow: var(--shadow-hover); }
        .popup-content h2 { font-size: 24px; margin-top: 0; }
        .popup-content p { font-size: 16px; color: var(--light-text); margin-bottom: 25px; }
        .popup-content button { width: 100%; padding: 14px; background-color: var(--primary-color); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: 600; }
        .admin-section { background-color: var(--white-color); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); margin-top: 20px; }
        .toggle-switch { display: flex; align-items: center; gap: 15px; margin-top: 20px; }
        .toggle-switch label { font-weight: 600; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;}
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;}
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .button-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .ad-container { width: 100%; margin: 20px 0; display: flex; justify-content: center; align-items: center; min-height: 50px; }
        .bottom-nav { position: fixed; left: 0; bottom: 0; width: 100%; background-color: var(--white-color); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 8px 0; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { position: relative; display: flex; flex-direction: column; align-items: center; color: var(--light-text); text-decoration: none; font-size: 12px; font-weight: 500; gap: 4px; padding: 5px 10px; border-radius: 8px; transition: color 0.3s, background-color 0.3s; background: transparent; border: none; cursor: pointer; }
        .nav-item svg { width: 26px; height: 26px; fill: var(--light-text); transition: fill 0.3s; }
        .nav-item.active, .nav-item:hover { color: var(--primary-color); }
        .nav-item.active svg, .nav-item:hover svg { fill: var(--primary-color); }
        .notification-dot { position: absolute; top: 2px; right: 12px; width: 8px; height: 8px; background-color: var(--danger-color); border-radius: 50%; display: none; }
        .home-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 25px; }
        .home-card { background-color: var(--white-color); padding: 25px; border-radius: 16px; box-shadow: var(--shadow); cursor: pointer; transition: all 0.2s; text-align: center; border: 1px solid transparent; }
        .home-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); color: var(--primary-color); border-color: var(--primary-color); }
        .home-card-icon { width: 50px; height: 50px; margin: 0 auto 15px auto; background-color: var(--light-bg); border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        .home-card-icon svg { width: 28px; height: 28px; fill: var(--primary-color); }
        .home-card-title { font-weight: 600; font-size: 16px; color: var(--dark-text); }
        .subject-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; text-align: center; }
        .subject-card { background-color: var(--white-color); padding: 30px 10px; border-radius: 16px; box-shadow: var(--shadow); cursor: pointer; transition: all 0.2s; font-weight: 600; color: var(--dark-text); border: 1px solid transparent; }
        .subject-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); color: var(--primary-color); border-color: var(--primary-color);}
        .notification-card { display: flex; align-items: flex-start; gap: 15px; background-color: var(--white-color); padding: 15px; margin-bottom: 12px; border-radius: 12px; box-shadow: var(--shadow); border-left: 4px solid var(--primary-color); cursor: pointer; transition: background-color 0.2s; }
        .notification-card:hover { background-color: var(--light-bg); }
        .notification-icon { flex-shrink: 0; }
        .notification-icon svg { width: 24px; height: 24px; fill: var(--primary-color); }
        .notification-content { flex-grow: 1; }
        .notification-content h4 { margin: 0 0 4px 0; color: var(--dark-text); font-size: 16px; text-align: left; }
        .notification-content small { font-size: 12px; color: var(--light-text); display: block; text-align: left; }
        .notification-message-full { display: none; margin-top: 10px; font-size: 14px; color: var(--dark-text); text-align: left; line-height: 1.6; }
        .notification-card.expanded .notification-message-full { display: block; }
        .quiz-header { margin-bottom: 20px; }
        .progress-container { width: 100%; background-color: var(--border-color); border-radius: 8px; height: 10px; margin-bottom: 8px; }
        .progress-bar { width: 0%; height: 100%; background-color: var(--primary-color); border-radius: 8px; transition: width 0.3s ease; }
        .progress-text { text-align: center; font-weight: 500; color: var(--light-text); }
        #question-container { min-height: 80px; }
        #options-container li { justify-content: flex-start; }
        .quiz-navigation { display: flex; justify-content: space-between; margin-top: 30px; }
        .quiz-nav-btn { width: 48%; padding: 14px; }
        .score-summary { background-color: var(--white-color); padding: 30px; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 30px; }
        .score-circle-container { position: relative; width: 150px; height: 150px; margin: 0 auto 20px auto; }
        .score-circle { width: 100%; height: 100%; border-radius: 50%; display: grid; place-items: center; background: conic-gradient(var(--primary-color) 0deg, var(--border-color) 0deg); transition: background 1s; }
        .score-circle::before { content: ''; position: absolute; width: 80%; height: 80%; background: var(--white-color); border-radius: 50%; }
        .score-value { position: relative; font-size: 36px; font-weight: 700; color: var(--primary-color); }
        .score-details { display: flex; justify-content: space-around; text-align: center; }
        .score-detail-item h4 { margin: 0 0 5px 0; font-size: 24px; font-weight: 700; }
        #correct-score { color: var(--success-color); }
        #incorrect-score { color: var(--danger-color); }
        .review-question { background: var(--white-color); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: var(--shadow); }
        .review-options li { display: flex; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border-color); }
        .review-options li .icon { margin-right: 10px; font-weight: bold; }
        .review-options li.correct { border-color: var(--success-color); background-color: #e9f7ec; }
        .review-options li.incorrect { border-color: var(--danger-color); background-color: #fceeee; }
        .bookmarked-question-item h4 { text-align: left; margin: 10px 0 15px 0; }
        .bookmarked-question-item .remove-bookmark-btn { background-color: var(--danger-color); color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; float: right; margin-top: 10px; }
        .download-item { justify-content: space-between; }
        .download-btn {
            background-color: var(--success-color); color: white; border: none; border-radius: 6px;
            padding: 8px 15px; cursor: pointer; text-decoration: none;
        }
        .admin-guess-item { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; }
        .admin-guess-item input { width: calc(100% - 20px); }
        .admin-guess-item button { width: auto; }
        
        /* NEW CSS FOR DEVELOPER LINK */
        #developer-link {
            display: inline-flex;
            align-items: center;
            gap: 8px; /* Icon aur text ke beech mein space */
            background-color: rgba(255, 255, 255, 0.15);
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        #developer-link:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05); /* Hover par thoda sa bada hoga */
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        #developer-link svg {
            fill: #fff; /* Icon ka color aafed rakhega */
        }
    </style>
</head>
<body>
    
    <div id="update-popup" class="popup-overlay"></div>

    <!-- Auth Pages -->
    <div id="signup-page" class="page active">
        <div class="login-wrapper">
            <img src="https://i.postimg.cc/g0tjTCdv/Adobe-Express-file.png" alt="Aarambh Ignite Logo" class="app-logo">
            <p class="app-tagline">Your learning companion</p>
            <div class="login-container">
                <h2>Create Account</h2> <p class="subtitle">Join us to start your journey</p>
                <form id="signup-form" onsubmit="handleSignup(event)">
                    <label for="signup-name">Full Name</label> <input type="text" id="signup-name" placeholder="Enter your full name" required>
                    <label for="signup-email">Email</label> <input type="email" id="signup-email" placeholder="Enter your email" required>
                    <label for="signup-password">Password</label> <input type="password" id="signup-password" placeholder="Create a password" required>
                    <label for="signup-confirm-password">Confirm Password</label> <input type="password" id="signup-confirm-password" placeholder="Confirm your password" required>
                    <button type="submit">Sign Up</button>
                </form>
                <div class="auth-switch-link"> Already have an account? <a onclick="showPage('login-page')">Login</a> </div>
                <div class="auth-switch-link" style="margin-top: 10px;"> <a onclick="showPage('admin-login-page')">Login as Admin</a> </div>
            </div>
        </div>
    </div>
    <div id="login-page" class="page">
        <div class="login-wrapper">
            <img src="https://i.postimg.cc/g0tjTCdv/Adobe-Express-file.png" alt="Aarambh Ignite Logo" class="app-logo">
            <p class="app-tagline">Your learning companion</p>
            <div class="login-container">
                <h2>Student Login</h2> <p class="subtitle">Sign in to continue your journey</p>
                <form onsubmit="event.preventDefault(); loginUser();">
                    <label for="login-email">Email</label> <input type="email" id="login-email" placeholder="Enter your email" required>
                    <label for="login-password">Password</label> <input type="password" id="login-password" placeholder="Enter your password" required>
                    <button type="submit">Login</button>
                </form>
                <div class="auth-switch-link"> Don't have an account? <a onclick="showPage('signup-page')">Sign Up</a> </div>
                 <div class="auth-switch-link" style="margin-top: 10px;"> <a onclick="showPage('admin-login-page')">Login as Admin</a> </div>
            </div>
        </div>
    </div>
    <div id="admin-login-page" class="page">
        <div class="login-wrapper">
            <img src="https://i.postimg.cc/g0tjTCdv/Adobe-Express-file.png" alt="Aarambh Ignite Logo" class="app-logo">
            <p class="app-tagline">Your learning companion</p>
            <div class="login-container">
                <h2>Admin Login</h2>
                <form onsubmit="event.preventDefault(); loginAdmin();">
                    <label for="admin-email">Admin Email</label> <input type="email" id="admin-email" placeholder="Enter your admin email" required>
                    <label for="admin-password">Admin Password</label> <input type="password" id="admin-password" placeholder="Enter your admin password" required>
                    <button type="submit">Admin Login</button>
                </form>
                <div class="auth-switch-link"> <a onclick="showPage('signup-page')">Back to Sign Up</a> </div>
            </div>
        </div>
    </div>

    <!-- User Dashboard -->
    <div id="user-dashboard" class="page">
        <div class="app-header">
            <img src="https://i.postimg.cc/g0tjTCdv/Adobe-Express-file.png" alt="Aarambh Ignite Logo" class="header-logo">
            <span class="welcome-text" id="user-name-display"></span>
            <div class="header-actions">
                <div class="profile-btn" onclick="showProfilePage()" title="Profile">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                </div>
                <div class="theme-toggle" id="theme-toggle-user" onclick="toggleTheme()"></div>
                <div class="logout-btn" onclick="logoutUser()" title="Logout">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 17v-3H9v-4h7V7l5 5-5 5M14 2a2 2 0 0 1 2 2v2h-2V4H5v16h9v-2h2v2a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9z"></path></svg>
                </div>
            </div>
        </div>
         <div class="banner"> 
            <p id="banner-text">Welcome to your learning journey!</p>
            <!-- UPDATED DEVELOPER LINK -->
            <a href="https://www.instagram.com/vinod0x_?igsh=amxxZ2h1Mm12MDgw" target="_blank" rel="noopener noreferrer" id="developer-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.9 3.9 0 0 0-1.417.923A3.9 3.9 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.703.01 5.556 0 5.829 0 8s.01 2.444.048 3.297c.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.556 15.99 5.829 16 8 16s2.444-.01 3.297-.048c.852-.04 1.433-.174 1.942-.372.526-.205.972-.478 1.417-.923.445-.444.718-.891.923-1.417.198-.51.333-1.09.372-1.942C15.99 10.444 16 10.171 16 8s-.01-2.444-.048-3.297c-.04-.852-.174-1.433-.372-1.942a3.9 3.9 0 0 0-.923-1.417A3.9 3.9 0 0 0 13.24.42c-.51-.198-1.09-.333-1.942-.372C10.444.01 10.171 0 8 0zm0 1.442c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599s.453.546.598.92c.11.281.24.705.275 1.486.039.843.047 1.096.047 3.232s-.008 2.389-.047 3.232c-.035.78-.166 1.204-.275 1.486a2.5 2.5 0 0 1-.599.92 2.5 2.5 0 0 1-.92.598c-.28.11-.704.24-1.486.275-.843.038-1.096.047-3.232.047s-2.389-.009-3.232-.047c-.78-.036-1.204-.166-1.486-.275a2.5 2.5 0 0 1-.92-.599 2.5 2.5 0 0 1-.598-.92c-.11-.281-.24-.705-.275-1.486-.038-.843-.047-1.096-.047-3.232s.009-2.389.047-3.232c.036-.78.166-1.204.275-1.486.145-.373.319-.64.599-.92s.546-.453.92-.598c.282-.11.705-.24 1.486-.275.843-.039 1.096-.047 3.232-.047zM8 4.865a3.135 3.135 0 1 0 0 6.27 3.135 3.135 0 0 0 0-6.27zM8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm4.875-6.19a1.125 1.125 0 1 0 0-2.25 1.125 1.125 0 0 0 0 2.25z"/>
                </svg>
                <span>DEVELOPERâ†’@VINOD0X_</span>
            </a>
        </div>
        <div id="dashboard-ad-container" class="ad-container"></div>
        <div class="home-grid">
            <div class="home-card" onclick="showUserAllSubjects()">
                <div class="home-card-icon"><svg viewBox="0 0 24 24"><path d="M12 3L1 9l4 2.18v6.32L1 12.5V17l11 6 11-6v-4.5l-4 2.18v-6.32L23 9l-11-6zm0 2.31L19.59 9 12 12.69 4.41 9 12 5.31zM6 13.5l6 3.27 6-3.27v2.54l-6 3.27-6-3.27v-2.54z"/></svg></div>
                <div class="home-card-title">Chapter by MCQ</div>
            </div>
            <div class="home-card" onclick="showYearSelection('model_papers', 'user')">
                 <div class="home-card-icon"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 18V6h16v12H4zm6-1H8v-2h2v2zm0-3H8V9h2v2zm0-3H8V6h2v2zm4 6h-2v-2h2v2zm0-3h-2V9h2v2zm0-3h-2V6h2v2zm4 6h-2v-2h2v2zm0-3h-2V9h2v2z"/></svg></div>
                <div class="home-card-title">Model Paper</div>
            </div>
             <div class="home-card" onclick="showYearSelection('pyqs', 'user')">
                <div class="home-card-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></div>
                <div class="home-card-title">PYQ</div>
            </div>
            <div class="home-card" onclick="showYearSelection('sentup_exam', 'user')">
                <div class="home-card-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h12c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1zM8 8h8v2H8zm8 4h-3v2h3zm-5-2h2v2h-2z"/></svg></div>
                <div class="home-card-title">Sentup Exam</div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="page">
        <div class="app-header">
            <p class="welcome-text" style="margin-left:0;">Admin Home</p>
            <div class="header-actions">
                <div class="theme-toggle" id="theme-toggle-admin" onclick="toggleTheme()"></div>
                <div class="logout-btn" onclick="logoutUser()" title="Logout">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 17v-3H9v-4h7V7l5 5-5 5M14 2a2 2 0 0 1 2 2v2h-2V4H5v16h9v-2h2v2a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9z"></path></svg>
                </div>
            </div>
        </div>
        <h3>Select Category to Manage</h3>
        <div class="subject-grid" style="margin-top:20px;">
            <div class="subject-card" onclick="showAdminSubjectSelection('subjects')"><span>Chapter by MCQs</span></div>
            <div class="subject-card" onclick="showYearSelection('model_papers', 'admin')"><span>Model Papers</span></div>
            <div class="subject-card" onclick="showYearSelection('pyqs', 'admin')"><span>PYQs</span></div>
            <div class="subject-card" onclick="showYearSelection('sentup_exam', 'admin')"><span>Sentup Exam</span></div>
            <div class="subject-card" onclick="showAdminGuessManager()"><span>Guess Questions</span></div>
            <div class="subject-card" onclick="showBannerManager()"><span>Manage Banner</span></div>
            <div class="subject-card" onclick="showUpdateManager()"><span>App Update</span></div>
        </div>
    </div>
    
    <!-- [FIXED] Full HTML structure for all pages -->
    <div id="list-display-page" class="page"></div>
    <div id="question-list-page" class="page"></div>
    <div id="quiz-page" class="page"></div>
    <div id="notification-page" class="page"></div>
    <div id="saved-questions-page" class="page"></div>
    <div id="guess-question-page" class="page"></div>
    <div id="admin-notification-page" class="page"></div>
    <div id="admin-update-manager-page" class="page"></div>
    <div id="admin-banner-manager-page" class="page"></div>
    <div id="admin-guess-question-manager-page" class="page"></div>
    <div id="admin-ad-manager" class="page"></div>
    <div id="download-manager-page" class="page"></div>
    <div id="admin-add-question-page" class="page"></div>
    <div id="edit-question-page" class="page"></div>
    <div id="score-page" class="page"></div>
    <div id="profile-page" class="page"></div>
    
    <!-- Bottom Nav Bars -->
    <div id="bottom-navigation-bar" style="display: none;">
        <div class="bottom-nav">
            <button class="nav-item active" onclick="handleNavClick(event, 'user-dashboard')"> <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg> <span>Home</span> </button>
            <button class="nav-item" onclick="handleNavClick(event, 'saved-questions-page')"> <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"></path></svg> <span>Saved</span> </button>
            <button class="nav-item" onclick="handleNavClick(event, 'guess-question-page')"> <svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 15H8v-2h8v2zm-1-4H7v-2h8v2zm-1-4H7V7h8v2z"/></svg> <span>Guess</span> </button>
            <button class="nav-item" id="notification-nav-item" onclick="handleNavClick(event, 'notification-page')"> 
                <span class="notification-dot"></span>
                <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg> 
                <span>Notification</span> 
            </button>
        </div>
    </div>
    <div id="admin-bottom-navigation-bar" style="display: none;">
        <div class="bottom-nav">
            <button class="nav-item active" onclick="handleAdminNavClick(event, 'admin-dashboard')"> <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg> <span>Home</span> </button>
            <button class="nav-item" onclick="handleAdminNavClick(event, 'admin-notification-page')"> <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg> <span>Notify</span> </button>
            <button class="nav-item" onclick="handleAdminNavClick(event, 'admin-ad-manager')"> <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zM4 18V6h16v12H4zm11-9h-4v2h4V9zm0 3h-4v2h4v-2z"/></svg> <span>Ads</span> </button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
    // [FIXED] All functions are now in the global scope
    const firebaseConfig = {
        apiKey: "AIzaSyBpr44AlSwPz7bpDJHEfCNqyhH3vN3G6Os",
        authDomain: "vinodquiz.firebaseapp.com",
        databaseURL: "https://vinodquiz-default-rtdb.firebaseio.com",
        projectId: "vinodquiz",
        storageBucket: "vinodquiz.appspot.com",
        messagingSenderId: "112423879978",
        appId: "1:112423879978:web:15b51c518498f7f0f50a53"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const database = firebase.database();
    
    let currentQuizPath = '', quizQuestions = [], userAnswers = {}, currentQuestionIndex = 0;
    let currentAdminPathDetails = {};
    let allSubjectsData = {};
    let adCodes = {};
    let quizHistory = [];

    const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45 1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.64 5.64zm12.73 12.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41l-1.06-1.06zM5.64 18.36l-1.06-1.06c-.39-.39-.39-1.02 0-1.41s1.02-.39 1.41 0l1.06 1.06c.39.39.39 1.02 0 1.41s-1.02.39-1.41 0zm12.73-12.73l-1.06-1.06c-.39-.39-.39-1.02 0-1.41s1.02-.39 1.41 0l1.06 1.06c.39.39.39 1.02 0 1.41s-1.02.39-1.41 0z"/></svg>`;
    const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.3 4.9c.4-.2.6-.7.4-1.1-.2-.4-.7-.6-1.1-.4C7.2 5.5 4 9.4 4 14c0 4.4 3.6 8 8 8 3.5 0 6.5-2.2 7.6-5.4.2-.4 0-.9-.4-1.1s-.9-.1-1.1.2c-.8 1.9-2.6 3.2-4.7 3.2-2.8 0-5-2.2-5-5 0-2.5 1.8-4.6 4.2-4.9z"/></svg>`;
    
    function applyTheme(theme) {
        const userToggle = document.getElementById('theme-toggle-user');
        const adminToggle = document.getElementById('theme-toggle-admin');
        if (theme === 'dark') { document.body.classList.add('dark-mode'); if(userToggle) userToggle.innerHTML = sunIcon; if(adminToggle) adminToggle.innerHTML = sunIcon; } 
        else { document.body.classList.remove('dark-mode'); if(userToggle) userToggle.innerHTML = moonIcon; if(adminToggle) adminToggle.innerHTML = moonIcon; }
    }
    function toggleTheme() {
        const newTheme = (localStorage.getItem('theme') || 'light') === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', newTheme); applyTheme(newTheme);
    }

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const page = document.getElementById(pageId); 
        if (page) page.classList.add('active');
        const isAdmin = localStorage.getItem('isAdmin') === 'true';
        const userPagesWithNav = ['user-dashboard', 'notification-page', 'saved-questions-page', 'guess-question-page', 'profile-page'];
        const userBottomNav = document.getElementById('bottom-navigation-bar');
        if (userBottomNav) userBottomNav.style.display = (!isAdmin && userPagesWithNav.includes(pageId)) ? 'flex' : 'none';
        const adminPagesWithNav = ['admin-dashboard', 'admin-notification-page', 'admin-ad-manager', 'admin-update-manager-page', 'admin-banner-manager-page', 'admin-guess-question-manager-page'];
        const adminBottomNav = document.getElementById('admin-bottom-navigation-bar');
        if (adminBottomNav) adminBottomNav.style.display = (isAdmin && (adminPagesWithNav.includes(pageId) || pageId.includes('list') || pageId.includes('question'))) ? 'flex' : 'none';
    }
    
    function handleNavClick(event, pageId) {
        event.preventDefault();
        document.querySelectorAll('#bottom-navigation-bar .nav-item').forEach(item => item.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if (pageId === 'notification-page') loadNotifications();
        if (pageId === 'saved-questions-page') loadBookmarkedQuestions();
        if (pageId === 'guess-question-page') showGuessQuestionPage();
        showPage(pageId);
    }

    function handleAdminNavClick(event, pageId) {
        event.preventDefault();
        document.querySelectorAll('#admin-bottom-navigation-bar .nav-item').forEach(item => item.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(pageId === 'admin-notification-page') showNotificationManager();
        else if(pageId === 'admin-ad-manager') showAdManager();
        else if(pageId === 'admin-dashboard') showPage('admin-dashboard');
    }

    function handleSignup(event) {
        event.preventDefault();
        const name = document.getElementById('signup-name').value.trim();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const confirmPassword = document.getElementById('signup-confirm-password').value;
        if (!name) return alert("Please enter your full name.");
        if (password !== confirmPassword) return alert("Passwords do not match.");
        auth.createUserWithEmailAndPassword(email, password)
            .then(cred => cred.user.updateProfile({ displayName: name }))
            .then(() => {
                localStorage.setItem('isAdmin', 'false');
                alert('Account created successfully! Logging you in...');
                window.location.reload();
            })
            .catch(err => alert(`Error: ${err.message}`));
    }
    
    function loginUser() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        localStorage.setItem('isAdmin', 'false');
        auth.signInWithEmailAndPassword(email, password).catch(err => alert(err.message));
    }
    
    function loginAdmin() {
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;
        if (!email || !password) return alert("Please enter admin email and password.");
        auth.signInWithEmailAndPassword(email, password)
            .then(userCredential => {
                const user = userCredential.user;
                return database.ref('admins/' + user.uid).once('value')
                    .then(snapshot => {
                        if (snapshot.exists() && snapshot.val() === true) {
                            localStorage.setItem('isAdmin', 'true');
                        } else {
                            auth.signOut();
                            throw new Error("You do not have permission to access the admin panel.");
                        }
                    });
            })
            .catch(err => alert("Admin login failed: " + err.message));
    }

    function logoutUser() { 
        if(confirm("Are you sure you want to logout?")) { 
            // Turn off all active listeners to prevent memory leaks
            database.ref('notifications').off();
            database.ref('update_info').off();
            if (currentQuizPath) database.ref(currentQuizPath).off();
            
            auth.signOut().then(() => {
                localStorage.removeItem('isAdmin');
                window.location.reload(); 
            });
        } 
    }

    function initializeApp() {
        applyTheme(localStorage.getItem('theme') || 'light');
        database.ref('subjects').on('value', snapshot => { if (snapshot.exists()) allSubjectsData = snapshot.val(); });
        database.ref('ad_units').on('value', snapshot => { if (snapshot.exists()) adCodes = snapshot.val(); });

        database.ref('site_settings/bannerText').on('value', snapshot => {
            const bannerTextEl = document.getElementById('banner-text');
            if (bannerTextEl) {
                if (snapshot.exists() && snapshot.val()) {
                    bannerTextEl.innerText = snapshot.val();
                } else {
                    bannerTextEl.innerText = "Welcome to your learning journey!";
                }
            }
        });

        function showUserDashboard(user) {
            listenForUpdates();
            checkForNewNotifications();
            let welcomeName = user.displayName ? user.displayName.split(' ')[0] : user.email.split('@')[0];
            document.getElementById('user-name-display').innerText = welcomeName;
            showPage('user-dashboard');
            injectAd('dashboard-ad-container', adCodes.dashboardAd);
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                const wantsAdmin = localStorage.getItem('isAdmin') === 'true';
                if (wantsAdmin) {
                    database.ref('admins/' + user.uid).once('value').then(snapshot => {
                        if (snapshot.exists() && snapshot.val() === true) {
                            showPage('admin-dashboard');
                        } else {
                            localStorage.setItem('isAdmin', 'false');
                            showUserDashboard(user);
                        }
                    });
                } else {
                    showUserDashboard(user);
                }
            } else {
                localStorage.removeItem('isAdmin');
                showPage('signup-page');
            }
        });
    }
    
    function listenForUpdates() {
        const updateRef = database.ref('update_info');
        updateRef.off(); 
        updateRef.on('value', snapshot => {
            const popup = document.getElementById('update-popup');
            if (snapshot.exists() && snapshot.val().isEnabled && snapshot.val().link) {
                const data = snapshot.val();
                popup.innerHTML = `<div class="popup-content"><h2>Update Required!</h2><p>${data.message}</p><button onclick="window.open('${data.link}', '_blank')">Update Now</button></div>`;
                popup.style.display = 'flex';
            } else {
                popup.style.display = 'none';
            }
        });
    }
    
    async function checkForNewNotifications() {
        const user = auth.currentUser; if (!user) return;
        const lastView = (await database.ref(`user_meta/${user.uid}/lastNotificationView`).once('value')).val() || 0;
        const notificationsRef = database.ref('notifications').orderByChild('createdAt').startAt(lastView + 1);
        
        notificationsRef.on('value', (snap) => {
            if (snap.exists()) {
                document.querySelector('.notification-dot').style.display = 'block';
            } else {
                document.querySelector('.notification-dot').style.display = 'none';
            }
        });
    }
    
    function startQuiz(path, title, backAction) {
        if (currentQuizPath) database.ref(currentQuizPath).off();
        currentQuizPath = path;
        quizHistory.push(backAction);
        const page = document.getElementById('quiz-page');
        page.innerHTML = `
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button id="quiz-back-button" class="back-button" style="flex-grow: 1; margin:0;">Quit Quiz</button>
                <button class="back-button" style="flex-grow: 1; margin:0; background-color: #ffc107;" onclick="bookmarkQuestion()">Bookmark Question</button>
            </div>
            <h2 id="quiz-title"></h2>
            <div class="quiz-header">
                <div class="progress-container"><div class="progress-bar" id="quiz-progress-bar"></div></div>
                <p class="progress-text" id="quiz-progress-text"></p>
            </div>
            <div id="quiz-page-ad-container" class="ad-container"></div>
            <div id="quiz-container"></div>
            <div class="quiz-navigation" style="display: none;">
                <button id="prev-question-btn" class="back-button quiz-nav-btn" onclick="prevQuestion()">Previous</button>
                <button id="next-question-btn" class="back-button quiz-nav-btn" onclick="nextQuestion()">Next</button>
            </div>`;
        
        page.querySelector('#quiz-title').innerText = title;
        page.querySelector('#quiz-back-button').onclick = backAction;
        showPage('quiz-page');
        const quizContainer = page.querySelector('#quiz-container');
        const navContainer = page.querySelector('.quiz-navigation');
        quizContainer.innerHTML = '<p>Loading questions...</p>';
        injectAd('quiz-page-ad-container', adCodes.quizPageAd);

        database.ref(path).on('value', snapshot => {
            quizQuestions = [];
            if (!snapshot.exists() || !snapshot.hasChildren()) {
                quizContainer.innerHTML = '<p>No questions found for this quiz.</p>';
                return;
            }
            snapshot.forEach(child => { quizQuestions.push({ id: child.key, ...child.val() }); });
            
            if (quizQuestions.length > 0) {
                quizContainer.innerHTML = `<div id="question-container" class="quiz-question"></div><ul id="options-container" class="list-container"></ul>`;
                navContainer.style.display = 'flex';
                userAnswers = new Array(quizQuestions.length).fill(null);
                currentQuestionIndex = 0; 
                showQuestion(currentQuestionIndex);
            } else {
                 quizContainer.innerHTML = '<p>No questions found for this quiz.</p>';
            }
        }, err => { quizContainer.innerHTML = `<p>Error loading quiz: ${err.message}</p>`; });
    }
    
    // [MODIFIED] Removed fake loading from showQuestion function
    function showQuestion(index) {
        const questionData = quizQuestions[index];
        const questionContainer = document.getElementById('question-container');
        const optionsContainer = document.getElementById('options-container');

        if (!questionContainer || !optionsContainer) return;

        questionContainer.innerHTML = `<h3>${questionData.question}</h3>`;
        
        optionsContainer.innerHTML = '';
        questionData.options.forEach((opt, i) => {
            const li = document.createElement('li');
            li.textContent = opt;
            li.onclick = () => selectAnswer(i + 1);
            if (userAnswers[index] === (i + 1)) {
                li.classList.add('selected');
            }
            optionsContainer.appendChild(li);
        });

        const progress = ((index + 1) / quizQuestions.length) * 100;
        document.getElementById('quiz-progress-bar').style.width = `${progress}%`;
        document.getElementById('quiz-progress-text').innerText = `Question ${index + 1} of ${quizQuestions.length}`;
        document.getElementById('prev-question-btn').style.visibility = index > 0 ? 'visible' : 'hidden';
        document.getElementById('next-question-btn').innerText = (index === quizQuestions.length - 1) ? 'Submit' : 'Next';
    }

    function selectAnswer(optionIndex) {
        userAnswers[currentQuestionIndex] = optionIndex;
        const optionsContainer = document.getElementById('options-container');
        // Re-render options to show selection
        optionsContainer.querySelectorAll('li').forEach((li, i) => {
            if ((i + 1) === optionIndex) {
                li.classList.add('selected');
            } else {
                li.classList.remove('selected');
            }
        });
    }

    // [MODIFIED] Removed fake loading from nextQuestion function
    function nextQuestion() {
        if (currentQuestionIndex < quizQuestions.length - 1) {
            injectAd('quiz-page-ad-container', adCodes.quizPageAd);
            currentQuestionIndex++;
            showQuestion(currentQuestionIndex);
        } else {
            calculateScore();
        }
    }

    // [MODIFIED] Removed fake loading from prevQuestion function
    function prevQuestion() {
        if (currentQuestionIndex > 0) {
            injectAd('quiz-page-ad-container', adCodes.quizPageAd);
            currentQuestionIndex--;
            showQuestion(currentQuestionIndex);
        }
    }
    
    // --- NOTIFICATION FUNCTIONS (UPDATED) ---

    function loadNotifications() {
        const page = document.getElementById('notification-page');
        page.innerHTML = `<div class="app-header"> <h2 style="text-align: left; flex-grow: 1;">Notifications</h2> </div><div id="notification-list-container"></div>`;
        const container = page.querySelector('#notification-list-container');
        container.innerHTML = '<p>Loading...</p>';
        
        const notificationsRef = database.ref('notifications').orderByChild('createdAt').limitToLast(30);
        
        // Use .on() for live updates
        notificationsRef.on('value', snapshot => {
            container.innerHTML = '';
            if (!snapshot.exists()) {
                container.innerHTML = '<p style="text-align: center; color: var(--light-text); margin-top: 50px;">No notifications yet.</p>';
                return;
            }
            
            const notifications = [];
            snapshot.forEach(child => notifications.push(child.val()));
            notifications.reverse().forEach(notif => {
                const card = document.createElement('div');
                card.className = 'notification-card';
                card.innerHTML = `<div class="notification-icon"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"></path></svg></div><div class="notification-content"><h4>${notif.title}</h4><small>${new Date(notif.createdAt).toLocaleString()}</small><p class="notification-message-full">${notif.message}</p></div>`;
                card.onclick = function() { this.classList.toggle('expanded'); };
                container.appendChild(card);
            });

            const user = auth.currentUser;
            if (user) {
                database.ref('user_meta/' + user.uid).update({ lastNotificationView: firebase.database.ServerValue.TIMESTAMP });
                document.querySelector('.notification-dot').style.display = 'none';
            }
        }, error => {
            console.error("Error loading notifications: ", error);
            container.innerHTML = '<p style="text-align: center; color: var(--danger-color);">Could not load notifications. Check console for errors.</p>';
        });
    }

    function showNotificationManager() {
        const page = document.getElementById('admin-notification-page');
        page.innerHTML = `<div class="app-header"> <h2 style="text-align: left; flex-grow: 1;">Manage Notifications</h2> </div><div class="admin-section"><h2>Send Notification</h2><form id="notification-form" onsubmit="handleNotificationSubmit(event)"><input type="hidden" id="notification-id"><label for="notification-title">Title:</label><input type="text" id="notification-title" required placeholder="e.g., New Update!"><label for="notification-message">Message:</label><textarea id="notification-message" rows="5" required placeholder="Enter the full notification message here..."></textarea><button type="submit" id="notification-submit-btn">Send to All Users</button></form></div><hr style="border: 0; border-top: 1px solid var(--border-color); margin: 30px 0;"><h3>Sent Notifications</h3><div id="admin-notification-list"></div>`;
        showPage('admin-notification-page');
        
        const container = page.querySelector('#admin-notification-list');
        container.innerHTML = '<p>Loading...</p>';
        
        const adminNotificationsRef = database.ref('notifications').orderByChild('createdAt');
        
        // Use .on() for live updates on admin panel too
        adminNotificationsRef.on('value', snapshot => {
            container.innerHTML = '';
            if (!snapshot.exists()) {
                container.innerHTML = '<p>No notifications sent yet.</p>';
                return;
            }
            const notifications = [];
            snapshot.forEach(child => notifications.push({ id: child.key, ...child.val() }));
            notifications.reverse().forEach(notif => {
                const item = document.createElement('div');
                item.className = 'question-list-item';
                item.innerHTML = `<div><strong>${notif.title}</strong><p style="color: var(--light-text); margin: 5px 0 0 0;">${notif.message}</p></div><div class="question-actions"><button class="edit-btn" onclick="editNotification('${notif.id}', \`${notif.title}\`, \`${notif.message}\`)">Edit</button><button class="delete-btn" onclick="deleteNotification('${notif.id}')">Delete</button></div>`;
                container.appendChild(item);
            });
        });
    }

    function handleNotificationSubmit(event) {
        event.preventDefault();
        const id = document.getElementById('notification-id').value;
        const title = document.getElementById('notification-title').value;
        const message = document.getElementById('notification-message').value;
        const btn = document.getElementById('notification-submit-btn');
        const notificationData = {
            title: title,
            message: message,
            createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        const promise = id ?
            database.ref('notifications/' + id).update(notificationData) :
            database.ref('notifications').push(notificationData);
            
        promise.then(() => {
            alert(id ? 'Notification updated!' : 'Notification sent!');
            event.target.reset();
            document.getElementById('notification-id').value = '';
            btn.textContent = 'Send to All Users';
        }).catch(err => alert(err.message));
    }
    
    // --- OTHER FUNCTIONS (UNCHANGED) ---

    function showGuessQuestionPage() {
        const page = document.getElementById('guess-question-page');
        page.innerHTML = `<div class="app-header"> <h2 style="text-align: left; flex-grow: 1;">Guess Questions</h2> </div><ul id="guess-question-list-container" class="list-container"><li>Loading subjects...</li></ul><div id="guess-page-ad-container" class="ad-container"></div>`;
        const container = page.querySelector('#guess-question-list-container');
        injectAd('guess-page-ad-container', adCodes.guessPageAd);
        showPage('guess-question-page');
        database.ref('guess_questions').on('value', linkSnapshot => {
            const links = linkSnapshot.val() || {};
            container.innerHTML = '';
            if (!allSubjectsData || Object.keys(allSubjectsData).length === 0) {
                container.innerHTML = '<li>No subjects found.</li>';
                return;
            }
            Object.keys(allSubjectsData).forEach(subjectId => {
                const subject = allSubjectsData[subjectId];
                const linkData = links[subjectId];
                const li = document.createElement('li');
                li.className = 'download-item';
                li.innerHTML = `<span>${subject.name}</span>`;
                if (linkData && linkData.link) {
                    li.innerHTML += `<a href="${linkData.link}" target="_blank" class="download-btn">Download</a>`;
                } else {
                    li.innerHTML += `<span>Coming Soon</span>`;
                }
                container.appendChild(li);
            });
        });
    }

    function showAdminGuessManager() {
        const page = document.getElementById('admin-guess-question-manager-page');
        page.innerHTML = `<button class="back-button" onclick="showPage('admin-dashboard')">Back</button><h2>Manage Guess Question Links</h2><div id="admin-guess-links-container"><p>Loading...</p></div>`;
        const container = page.querySelector('#admin-guess-links-container');
        showPage('admin-guess-question-manager-page');
        database.ref('guess_questions').on('value', linkSnapshot => {
            const links = linkSnapshot.val() || {};
            container.innerHTML = '';
            if (!allSubjectsData || Object.keys(allSubjectsData).length === 0) {
                container.innerHTML = '<p>No subjects found. Add subjects first.</p>';
                return;
            }
            Object.keys(allSubjectsData).forEach(subjectId => {
                const subject = allSubjectsData[subjectId];
                const existingLink = (links[subjectId] && links[subjectId].link) || '';
                const section = document.createElement('div');
                section.className = 'admin-section admin-guess-item';
                section.innerHTML = `
                    <label for="guess-link-${subjectId}">${subject.name} Download Link:</label>
                    <input type="url" id="guess-link-${subjectId}" value="${existingLink}" placeholder="https://example.com/file.pdf">
                    <button onclick="saveGuessQuestionLink('${subjectId}')">Save Link</button>
                `;
                container.appendChild(section);
            });
        });
    }

    function saveGuessQuestionLink(subjectId) {
        const input = document.getElementById(`guess-link-${subjectId}`);
        const newLink = input.value.trim();
        database.ref(`guess_questions/${subjectId}`).set({ link: newLink })
            .then(() => alert(`${allSubjectsData[subjectId].name} link saved!`))
            .catch(err => alert('Error: ' + err.message));
    }

    function showBannerManager() {
        const page = document.getElementById('admin-banner-manager-page');
        page.innerHTML = `<button class="back-button" onclick="showPage('admin-dashboard')">Back</button><div class="admin-section"><h2>Manage Banner Text</h2><form onsubmit="event.preventDefault(); saveBannerText();"><label for="banner-text-input">Banner Text:</label><textarea id="banner-text-input" rows="3" required></textarea><button type="submit">Save Banner Text</button></form></div>`;
        showPage('admin-banner-manager-page');
        const input = page.querySelector('#banner-text-input');
        input.value = 'Loading...';
        database.ref('site_settings/bannerText').once('value', snapshot => {
            if (snapshot.exists() && snapshot.val()) {
                input.value = snapshot.val();
            } else {
                input.value = "Welcome to your learning journey!";
            }
        });
    }

    function saveBannerText() {
        const newText = document.getElementById('banner-text-input').value;
        database.ref('site_settings/bannerText').set(newText)
            .then(() => {
                alert('Banner text updated!');
                showPage('admin-dashboard');
            })
            .catch(err => alert('Error: ' + err.message));
    }

    function showAdManager() {
        const page = document.getElementById('admin-ad-manager');
        page.innerHTML = `<div class="app-header"> <h2 style="text-align: left; flex-grow: 1;">Manage Ads</h2> </div><div class="admin-section"><h2>Manage Ad Units</h2><form id="ad-form" onsubmit="event.preventDefault(); saveAdSettings();"><label for="dashboard-ad-code">Dashboard Ad Code:</label> <textarea id="dashboard-ad-code" rows="5"></textarea><label for="year-list-ad-code">Year List Ad Code:</label> <textarea id="year-list-ad-code" rows="5"></textarea><label for="subject-list-ad-code">Subject List Ad Code:</label> <textarea id="subject-list-ad-code" rows="5"></textarea><label for="shift-list-ad-code">Shift List Ad Code:</label> <textarea id="shift-list-ad-code" rows="5"></textarea><label for="score-page-ad-code">Score Page Ad Code:</label> <textarea id="score-page-ad-code" rows="5"></textarea><label for="quiz-page-ad-code">Quiz Page Ad Code:</label> <textarea id="quiz-page-ad-code" rows="5"></textarea><label for="guess-page-ad-code">Guess Question Page Ad Code:</label> <textarea id="guess-page-ad-code" rows="5"></textarea><label for="rewarded-ad-code">Rewarded Video Ad Code:</label> <textarea id="rewarded-ad-code" rows="5"></textarea><button type="submit">Save Ad Settings</button></form></div>`;
        showPage('admin-ad-manager');
        database.ref('ad_units').once('value', snapshot => {
            if (snapshot.exists()) {
                const codes = snapshot.val();
                document.getElementById('dashboard-ad-code').value = codes.dashboardAd || '';
                document.getElementById('year-list-ad-code').value = codes.yearListAd || '';
                document.getElementById('subject-list-ad-code').value = codes.subjectListAd || '';
                document.getElementById('shift-list-ad-code').value = codes.shiftListAd || '';
                document.getElementById('score-page-ad-code').value = codes.scorePageAd || '';
                document.getElementById('quiz-page-ad-code').value = codes.quizPageAd || '';
                document.getElementById('guess-page-ad-code').value = codes.guessPageAd || '';
                document.getElementById('rewarded-ad-code').value = codes.rewardedVideoAd || '';
            }
        });
    }
    function saveAdSettings() {
        try {
            const adData = {
                dashboardAd: document.getElementById('dashboard-ad-code').value,
                yearListAd: document.getElementById('year-list-ad-code').value,
                subjectListAd: document.getElementById('subject-list-ad-code').value,
                shiftListAd: document.getElementById('shift-list-ad-code').value,
                scorePageAd: document.getElementById('score-page-ad-code').value,
                quizPageAd: document.getElementById('quiz-page-ad-code').value,
                guessPageAd: document.getElementById('guess-page-ad-code').value,
                rewardedVideoAd: document.getElementById('rewarded-ad-code').value
            };
            database.ref('ad_units').set(adData).then(() => {
                alert("Ad settings saved successfully!");
                showPage('admin-dashboard');
            }).catch(err => alert("Failed to save ad settings: " + err.message));
        } catch (e) {
            alert("An error occurred: " + e.message);
        }
    }
    
    function injectAd(containerId, adCode) {
        const container = document.getElementById(containerId);
        if (!container || !adCode) { if(container) container.innerHTML = ''; return; }
        container.innerHTML = adCode;
        Array.from(container.querySelectorAll("script")).forEach( oldScript => {
            const newScript = document.createElement("script");
            Array.from(oldScript.attributes).forEach( attr => newScript.setAttribute(attr.name, attr.value) );
            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
            oldScript.parentNode.replaceChild(newScript, oldScript);
        });
    }
    
    function showListPage(title, items, backAction, addBtnConfig = null, adType = null) { const page = document.getElementById('list-display-page'); page.innerHTML = `<button class="back-button">Back</button><div style="display: flex; justify-content: space-between; align-items: center;"><h2 id="list-title">${title}</h2>${addBtnConfig ? `<button id="add-item-btn" class="back-button" style="margin: 0;">${addBtnConfig.text}</button>` : ''}</div><ol id="list-items-container" class="list-container" style="padding-left: 0;"></ol><div id="list-page-ad-container" class="ad-container"></div>`; const container = page.querySelector('#list-items-container'); if (items && items.length > 0) { items.forEach(item => { const li = document.createElement('li'); const textSpan = document.createElement('span'); textSpan.innerText = item.text; if (item.adminControls) { li.appendChild(textSpan); const controls = document.createElement('div'); controls.innerHTML = item.adminControls; li.appendChild(controls); textSpan.style.cursor = 'pointer'; textSpan.onclick = item.handler; } else { li.appendChild(textSpan); li.onclick = item.handler; } container.appendChild(li); }); } else { container.innerHTML = '<li>No items found.</li>'; } page.querySelector('.back-button').onclick = backAction; const addBtn = page.querySelector('#add-item-btn'); if(addBtn) addBtn.onclick = addBtnConfig.handler; injectAd('list-page-ad-container', adCodes[adType]); showPage('list-display-page'); }
    function showYearSelection(category, mode) { const years = ["2020", "2021", "2022", "2023", "2024", "2025"]; const backAction = () => showPage(mode === 'user' ? 'user-dashboard' : 'admin-dashboard'); const categoryName = category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); const items = years.map(year => ({ text: year, handler: () => showSubjectSelectionForYear(category, year, mode) })); showListPage(`${categoryName} - Select Year`, items, backAction, null, 'yearListAd'); }
    function showSubjectSelectionForYear(category, year, mode) { const title = `${year} - Select Subject`; const backAction = () => showYearSelection(category, mode); const items = Object.keys(allSubjectsData).map(subjectId => { return { text: allSubjectsData[subjectId].name, handler: () => { if (category === 'pyqs') { showShiftSelection(category, year, subjectId, mode); } else { const path = `${category}/${year}/${subjectId}/questions`; const quizTitle = `${year} ${allSubjectsData[subjectId].name}`; const backFn = () => showSubjectSelectionForYear(category, year, mode); if (mode === 'user') startQuiz(path, quizTitle, backFn); else { currentQuizPath = path; currentAdminPathDetails = { category, year, subjectId }; showQuestionList(); } } } } }); showListPage(title, items, backAction, null, 'subjectListAd'); }
    function showShiftSelection(category, year, subjectId, mode) { const shifts = [{ id: 'shift_1', name: '1st Shift' }, { id: 'shift_2', name: '2nd Shift' }]; const title = `${year} ${allSubjectsData[subjectId].name} - Select Shift`; const backAction = () => showSubjectSelectionForYear(category, year, mode); const items = shifts.map(shift => { const path = `${category}/${year}/${subjectId}/${shift.id}/questions`; return { text: shift.name, handler: () => { const quizTitle = `${year} ${allSubjectsData[subjectId].name} - ${shift.name}`; const backFn = () => showShiftSelection(category, year, subjectId, mode); if (mode === 'user') startQuiz(path, quizTitle, backFn); else { currentQuizPath = path; currentAdminPathDetails = { category, year, subjectId, shift: shift.id }; showQuestionList(); } } } }); showListPage(title, items, backAction, null, 'shiftListAd'); }
    function showAdminSubjectSelection() { const items = Object.keys(allSubjectsData).map(subjectId => ({ text: allSubjectsData[subjectId].name, handler: () => { currentAdminPathDetails = { category: 'subjects', subjectId }; showAdminChapterList(subjectId); } })); showListPage('Select Subject', items, () => showPage('admin-dashboard'), null, 'subjectListAd'); }
    function showAdminChapterList(subjectId) { const subject = allSubjectsData[subjectId], chapters = subject.chapters || {}; const sortedKeys = Object.keys(chapters).sort((a,b) => (chapters[a].createdAt || 0) - (chapters[b].createdAt || 0)); const items = sortedKeys.map((chapterId, index) => ({ text: `${index + 1}. ${chapters[chapterId].title}`, handler: () => { if (subjectId === 'math') { currentAdminPathDetails.chapterId = chapterId; showAdminTopicList(subjectId, chapterId, index + 1); } else { currentQuizPath = `subjects/${subjectId}/chapters/${chapterId}/questions`; currentAdminPathDetails.chapterId = chapterId; showQuestionList(); } }, adminControls: `<div><button class='chapter-edit-btn edit-btn' onclick='event.stopPropagation(); editChapterName("${subjectId}", "${chapterId}", "${chapters[chapterId].title}")'>Edit</button></div>` })); const addBtnConfig = { text: '+ Add Chapter', handler: () => addChapter(subjectId) }; showListPage(`${subject.name} - Chapters`, items, showAdminSubjectSelection, addBtnConfig); }
    function showAdminTopicList(subjectId, chapterId, chapterIndex) { const chapter = allSubjectsData[subjectId].chapters[chapterId], topics = chapter.topics || {}; const sortedKeys = Object.keys(topics).sort((a,b) => (topics[a].createdAt || 0) - (topics[b].createdAt || 0)); const items = sortedKeys.map((topicId, topicIndex) => ({ text: `${chapterIndex}.${topicIndex + 1}. ${topics[topicId].title}`, handler: () => { currentAdminPathDetails.topicId = topicId; currentQuizPath = `subjects/${subjectId}/chapters/${chapterId}/topics/${topicId}/questions`; showQuestionList(); }, adminControls: `<div><button class='chapter-edit-btn edit-btn' onclick='event.stopPropagation(); editTopicName("${subjectId}", "${chapterId}", "${topicId}", "${topics[topicId].title}")'>Edit</button></div>` })); const addBtnConfig = { text: '+ Add Topic', handler: () => addTopic(subjectId, chapterId) }; showListPage(`${chapter.title} - Topics`, items, () => showAdminChapterList(subjectId), addBtnConfig); }
    function showUserAllSubjects() { const items = Object.keys(allSubjectsData).map(subjectId => ({ text: allSubjectsData[subjectId].name.toUpperCase(), handler: () => showSubjectChapters(subjectId) })); showListPage('Select Subject', items, () => showPage('user-dashboard')); }
    function showSubjectChapters(subjectId) { const subject = allSubjectsData[subjectId]; if (!subject.chapters) return alert('No chapters available.'); const chapters = subject.chapters, sortedKeys = Object.keys(chapters).sort((a, b) => (chapters[a].createdAt || 0) - (chapters[b].createdAt || 0)); const items = sortedKeys.map((chapterId, index) => ({ text: `${index + 1}. ${chapters[chapterId].title}`, handler: () => { if (subjectId === 'math') showTopicsForChapter(subjectId, chapterId, index + 1); else startQuiz(`subjects/${subjectId}/chapters/${chapterId}/questions`, chapters[chapterId].title, () => showSubjectChapters(subjectId)); } })); showListPage(subject.name, items, () => showUserAllSubjects(), null, 'subjectListAd'); }
    function showTopicsForChapter(subjectId, chapterId, chapterIndex) { const chapter = allSubjectsData[subjectId].chapters[chapterId], topics = chapter.topics || {}; const sortedKeys = Object.keys(topics).sort((a, b) => (topics[a].createdAt || 0) - (topics[b].createdAt || 0)); const items = sortedKeys.map((topicId, topicIndex) => ({ text: `${chapterIndex}.${topicIndex + 1}. ${topics[topicId].title}`, handler: () => startQuiz(`subjects/${subjectId}/chapters/${chapterId}/topics/${topicId}/questions`, topics[topicId].title, () => showTopicsForChapter(subjectId, chapterId, chapterIndex)) })); showListPage(chapter.title, items, () => showSubjectChapters(subjectId)); }
    function calculateScore() { const page = document.getElementById('score-page'); page.innerHTML = `<h2>Quiz Results</h2><div class="score-summary"><div class="score-circle-container"><div class="score-circle" id="score-circle"><span class="score-value" id="score-value-percent">0%</span></div></div><div class="score-details"><div class="score-detail-item"> <h4 id="correct-score">0</h4> <p>Correct</p> </div><div class="score-detail-item"> <h4 id="incorrect-score">0</h4> <p>Incorrect</p> </div><div class="score-detail-item"> <h4 id="total-score">0</h4> <p>Total</p> </div></div></div><div id="quiz-results-container"></div><div id="score-page-ad-container" class="ad-container"></div><button id="download-pdf-btn" class="back-button" style="display: none; background-color: var(--success-color); width: 100%; margin: 10px 0;">Download PDF</button><button id="score-back-button" class="back-button" style="width: 100%; margin-top: 0;">Finish</button>`; let correctCount = quizQuestions.filter((q, i) => userAnswers[i] === q.answer).length; const totalQuestions = quizQuestions.length; const percentage = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 0; page.querySelector('#score-value-percent').textContent = `${percentage}%`; page.querySelector('#score-circle').style.background = `conic-gradient(var(--primary-color) ${percentage * 3.6}deg, var(--border-color) 0deg)`; page.querySelector('#correct-score').textContent = correctCount; page.querySelector('#incorrect-score').textContent = totalQuestions - correctCount; page.querySelector('#total-score').textContent = totalQuestions; let resultsHTML = '<h3>Review Your Answers</h3>'; quizQuestions.forEach((q, i) => { resultsHTML += `<div class="review-question"><h4>Q${i + 1}: ${q.question}</h4><ul class="review-options">`; q.options.forEach((opt, j) => { const optNum = j + 1; let className = '', icon = ''; if (optNum === q.answer) { className = 'correct'; icon = 'âœ“'; } else if (optNum === userAnswers[i]) { className = 'incorrect'; icon = 'âœ—'; } resultsHTML += `<li class="${className}"><span class="icon">${icon}</span> ${opt}</li>`; }); resultsHTML += '</ul></div>'; }); page.querySelector('#quiz-results-container').innerHTML = resultsHTML; const parentPath = currentQuizPath.substring(0, currentQuizPath.lastIndexOf('/')); const downloadBtn = page.querySelector('#download-pdf-btn'); downloadBtn.style.display = 'none'; database.ref(`${parentPath}/downloadInfo`).once('value', snap => { if (snap.exists() && snap.val().isEnabled && snap.val().link) { downloadBtn.style.display = 'block'; downloadBtn.onclick = () => window.open(snap.val().link, '_blank'); } }); page.querySelector('#score-back-button').onclick = () => { if(currentQuizPath) { database.ref(currentQuizPath).off() }; const backAction = quizHistory.pop(); if (backAction) backAction(); else showPage('user-dashboard'); }; injectAd('score-page-ad-container', adCodes.scorePageAd); showPage('score-page'); }
    function bookmarkQuestion() { if (!quizQuestions || quizQuestions.length === 0) return alert('Cannot bookmark now.'); const currentQuestion = quizQuestions[currentQuestionIndex]; const quizTitle = document.getElementById('quiz-title').innerText; const questionId = 'q_' + (currentQuestion.id || currentQuestion.question.replace(/\s/g, '').substring(0, 20)); let bookmarked = JSON.parse(localStorage.getItem('bookmarkedQuestions') || '{}'); if (bookmarked[questionId]) { alert('This question is already bookmarked.'); return; } bookmarked[questionId] = { ...currentQuestion, quizTitle: quizTitle }; localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarked)); alert('Question bookmarked successfully!'); }
    function loadBookmarkedQuestions() { const page = document.getElementById('saved-questions-page'); page.innerHTML = `<div class="app-header"> <h2 style="text-align: left; flex-grow: 1;">Bookmarked Questions</h2> </div><div id="bookmarked-question-list-container"></div>`; const container = page.querySelector('#bookmarked-question-list-container'); container.innerHTML = ''; let bookmarked = JSON.parse(localStorage.getItem('bookmarkedQuestions') || '{}'); const questionIds = Object.keys(bookmarked); if (questionIds.length === 0) { container.innerHTML = '<p style="text-align: center; color: var(--light-text);">You have no bookmarked questions.</p>'; return; } questionIds.forEach((id) => { const q = bookmarked[id]; let optionsHTML = ''; q.options.forEach((opt, j) => { const optNum = j + 1; let className = '', icon = ''; if (optNum === q.answer) { className = 'correct'; icon = 'âœ“'; } optionsHTML += `<li class="${className}"><span class="icon">${icon}</span> ${opt}</li>`; }); const item = document.createElement('div'); item.className = 'bookmarked-question-item'; item.innerHTML = `<small>From Quiz: ${q.quizTitle}</small><h4>Q: ${q.question}</h4><ul class="review-options">${optionsHTML}</ul><button class="remove-bookmark-btn" onclick="removeBookmarkedQuestion('${id}')">Remove</button><div style="clear:both;"></div>`; container.appendChild(item); }); }
    function removeBookmarkedQuestion(questionId) { if (!confirm('Are you sure you want to remove this bookmark?')) return; let bookmarked = JSON.parse(localStorage.getItem('bookmarkedQuestions') || '{}'); delete bookmarked[questionId]; localStorage.setItem('bookmarkedQuestions', JSON.stringify(bookmarked)); loadBookmarkedQuestions(); }
    function showUpdateManager() { const page = document.getElementById('admin-update-manager-page'); page.innerHTML = `<button class="back-button" onclick="showPage('admin-dashboard')">Back</button><div class="admin-section"><h2>App Update Settings</h2><form id="update-form" onsubmit="event.preventDefault(); saveUpdateSettings();"><label>Popup Message:</label><textarea id="update-message" rows="4" required></textarea><label>Update Link:</label><input type="url" id="update-link" required><div class="toggle-switch"><label>Disable / Enable Popup</label><label class="switch"><input type="checkbox" id="update-enabled"><span class="slider"></span></label></div><button type="submit">Save Settings</button></form></div>`; showPage('admin-update-manager-page'); database.ref('update_info').once('value', snapshot => { if (snapshot.exists()) { const data = snapshot.val(); document.getElementById('update-message').value = data.message || ''; document.getElementById('update-link').value = data.link || ''; document.getElementById('update-enabled').checked = data.isEnabled || false; } else { document.getElementById('update-form').reset(); } }); }
    function saveUpdateSettings() { const message = document.getElementById('update-message').value; const link = document.getElementById('update-link').value; const isEnabled = document.getElementById('update-enabled').checked; database.ref('update_info').set({ message, link, isEnabled }).then(() => alert("Update settings saved!")).catch(err => alert("Error: " + err.message)); }
    function showProfilePage() { const page = document.getElementById('profile-page'); page.innerHTML = `<button class="back-button" onclick="showPage('user-dashboard')">Back to Dashboard</button><h2>My Profile</h2><div class="admin-section"><div class="profile-info"><h3 id="profile-name"></h3><p id="profile-email"></p></div><hr style="border: 0; border-top: 1px solid var(--border-color); margin: 20px 0;"><h4>Change Password</h4><form id="update-password-form" onsubmit="updateUserPassword(event)"><label for="old-password">Old Password</label><input type="password" id="old-password" placeholder="Enter your current password" required><label for="new-password">New Password</label><input type="password" id="new-password" placeholder="Enter a new password" required><label for="confirm-new-password">Confirm New Password</label><input type="password" id="confirm-new-password" placeholder="Confirm your new password" required><button type="submit">Update Password</button></form></div>`; const user = auth.currentUser; if (!user) return; document.getElementById('profile-name').innerText = user.displayName || 'User'; document.getElementById('profile-email').innerText = user.email; document.getElementById('update-password-form').reset(); showPage('profile-page'); }
    function updateUserPassword(event) { event.preventDefault(); const oldPass = document.getElementById('old-password').value, newPass = document.getElementById('new-password').value, confirmNewPass = document.getElementById('confirm-new-password').value; if (newPass.length < 6) return alert("Password must be at least 6 characters long."); if (newPass !== confirmNewPass) return alert("New passwords do not match."); const user = auth.currentUser; const credential = firebase.auth.EmailAuthProvider.credential(user.email, oldPass); user.reauthenticateWithCredential(credential).then(() => user.updatePassword(newPass)).then(() => { alert("Password updated!"); event.target.reset(); }).catch(error => alert("Error: " + error.message)); }
    function showQuestionList() { const page = document.getElementById('question-list-page'); page.innerHTML = `<button id="question-list-back-button" class="back-button">Back</button> <h2 id="question-list-title">Questions</h2><div class="button-group"><button onclick="showAdminAddQuestion()" class="back-button" style="margin:0;">+ Add New Question</button><button onclick="showDownloadManager()" class="back-button" style="margin:0; background-color: var(--success-color);">Manage Download</button></div><div id="questions-container" style="margin-top: 20px;"></div>`; let backAction; if (currentAdminPathDetails.category === 'subjects') { backAction = currentAdminPathDetails.topicId ? () => showAdminTopicList(currentAdminPathDetails.subjectId, currentAdminPathDetails.chapterId) : () => showAdminChapterList(currentAdminPathDetails.subjectId); } else { backAction = currentAdminPathDetails.shift ? () => showShiftSelection(currentAdminPathDetails.category, currentAdminPathDetails.year, currentAdminPathDetails.subjectId, 'admin') : () => showSubjectSelectionForYear(currentAdminPathDetails.category, currentAdminPathDetails.year, 'admin'); } page.querySelector('#question-list-back-button').onclick = backAction; const container = page.querySelector('#questions-container'); container.innerHTML = '<p>Loading...</p>'; showPage('question-list-page'); database.ref(currentQuizPath).on('value', snapshot => { container.innerHTML = ''; if (!snapshot.exists()) { container.innerHTML = '<p>No questions yet.</p>'; return; } snapshot.forEach(child => { const q = child.val(), qId = child.key; const item = document.createElement('div'); item.className = 'question-list-item'; item.innerHTML = `<span>${q.question}</span><div class="question-actions"><button class="edit-btn" onclick='showEditQuestion("${qId}")'>Edit</button><button class="delete-btn" onclick='deleteQuestion("${qId}")'>Delete</button></div>`; container.appendChild(item); }); }); }
    window.showEditQuestion = function(qId) { const page = document.getElementById('edit-question-page'); page.innerHTML = `<button id="edit-question-back-button" class="back-button">Back to List</button> <h2>Edit Question</h2><form id="edit-question-form" onsubmit="updateQuestion(event)"> <input type="hidden" id="edit-question-id"> <label>Question:</label><textarea id="edit-question-text" rows="3" required></textarea> <label>Options:</label><input type="text" id="edit-option1" placeholder="Opt 1" required><input type="text" id="edit-option2" placeholder="Opt 2" required><input type="text" id="edit-option3" placeholder="Opt 3" required><input type="text" id="edit-option4" placeholder="Opt 4" required> <label>Correct Option Number (1-4):</label><input type="number" id="edit-right-option-number" placeholder="e.g., 2" required min="1" max="4"> <button type="submit">Update</button> </form>`; database.ref(`${currentQuizPath}/${qId}`).once('value', snapshot => { if(!snapshot.exists()) return alert("Question not found!"); const q = snapshot.val(); document.getElementById('edit-question-id').value = qId; document.getElementById('edit-question-text').value = q.question; ['edit-option1', 'edit-option2', 'edit-option3', 'edit-option4'].forEach((id, i) => document.getElementById(id).value = (q.options || [])[i] || ''); document.getElementById('edit-right-option-number').value = q.answer; document.getElementById('edit-question-back-button').onclick = showQuestionList; showPage('edit-question-page'); }); }
    function showAdminAddQuestion() { const page = document.getElementById('admin-add-question-page'); page.innerHTML = `<button id="add-question-back-button" class="back-button">Back to List</button> <h2>Add New Question</h2><form id="add-question-form" onsubmit="publishQuestion(event)"> <label>Question:</label><textarea id="question-text" rows="3" required></textarea> <label>Options:</label><input type="text" id="option1" placeholder="Opt 1" required><input type="text" id="option2" placeholder="Opt 2" required><input type="text" id="option3" placeholder="Opt 3" required><input type="text" id="option4" placeholder="Opt 4" required> <label>Correct Option Number (1-4):</label><input type="number" id="right-option-number" placeholder="e.g., 2" required min="1" max="4"> <button type="submit">Publish</button> </form>`; document.getElementById('add-question-back-button').onclick = showQuestionList; showPage('admin-add-question-page'); }
    function publishQuestion(event) { event.preventDefault(); const data = { question: document.getElementById('question-text').value, options: [document.getElementById('option1').value, document.getElementById('option2').value, document.getElementById('option3').value, document.getElementById('option4').value], answer: parseInt(document.getElementById('right-option-number').value) }; database.ref(currentQuizPath).push(data).then(showQuestionList).catch(err => alert("Failed: " + err.message)); }
    function updateQuestion(event) { event.preventDefault(); const qId = document.getElementById('edit-question-id').value; const data = { question: document.getElementById('edit-question-text').value, options: [document.getElementById('edit-option1').value, document.getElementById('edit-option2').value, document.getElementById('edit-option3').value, document.getElementById('edit-option4').value], answer: parseInt(document.getElementById('edit-right-option-number').value) }; database.ref(`${currentQuizPath}/${qId}`).update(data).then(showQuestionList).catch(err => alert("Failed: " + err.message)); }
    function deleteQuestion(qId) { if (confirm('Are you sure?')) database.ref(`${currentQuizPath}/${qId}`).remove().catch(err => alert(err.message)); }
    function addChapter(subjectId) { const title = prompt("Enter new chapter title:"); if (title) database.ref(`subjects/${subjectId}/chapters`).push({ title, createdAt: firebase.database.ServerValue.TIMESTAMP }).catch(err => alert(err.message)); }
    function addTopic(subjectId, chapterId) { const title = prompt("Enter new topic title:"); if (title) database.ref(`subjects/${subjectId}/chapters/${chapterId}/topics`).push({ title, createdAt: firebase.database.ServerValue.TIMESTAMP }).catch(err => alert(err.message)); }
    function editChapterName(subjectId, chapterId, oldTitle) { const newTitle = prompt("Enter new chapter title:", oldTitle); if (newTitle && newTitle !== oldTitle) database.ref(`subjects/${subjectId}/chapters/${chapterId}/title`).set(newTitle).catch(err => alert(err.message)); }
    function editTopicName(subjectId, chapterId, topicId, oldTitle) { const newTitle = prompt("Enter new topic title:", oldTitle); if (newTitle && newTitle !== oldTitle) database.ref(`subjects/${subjectId}/chapters/${chapterId}/topics/${topicId}/title`).set(newTitle).catch(err => alert(err.message)); }
    function showDownloadManager() { const page = document.getElementById('download-manager-page'); page.innerHTML = `<button id="download-manager-back-button" class="back-button">Back to Questions</button><div class="admin-section"><h2>Manage Download Link</h2><form id="download-form" onsubmit="event.preventDefault(); saveDownloadInfo();"><label for="download-link">PDF/File Link:</label> <input type="url" id="download-link" placeholder="https://example.com/file.pdf"><div class="toggle-switch"> <label>Disable / Enable Download</label> <label class="switch"> <input type="checkbox" id="download-enabled"> <span class="slider"></span> </label> </div><button type="submit">Save Settings</button></form></div>`; document.getElementById('download-manager-back-button').onclick = showQuestionList; document.getElementById('download-form').reset(); const parentPath = currentQuizPath.substring(0, currentQuizPath.lastIndexOf('/')); database.ref(`${parentPath}/downloadInfo`).once('value', snapshot => { if (snapshot.exists()) { const data = snapshot.val(); document.getElementById('download-link').value = data.link || ''; document.getElementById('download-enabled').checked = data.isEnabled || false; } }); showPage('download-manager-page'); }
    function saveDownloadInfo() { const link = document.getElementById('download-link').value; const isEnabled = document.getElementById('download-enabled').checked; const parentPath = currentQuizPath.substring(0, currentQuizPath.lastIndexOf('/')); database.ref(`${parentPath}/downloadInfo`).set({ link, isEnabled }).then(() => { alert("Settings saved!"); showQuestionList(); }).catch(err => alert(err.message)); }
    function editNotification(id, title, message) { document.getElementById('notification-id').value = id; document.getElementById('notification-title').value = title; document.getElementById('notification-message').value = message; document.getElementById('notification-submit-btn').textContent = 'Update Notification'; window.scrollTo(0, 0); }
    function deleteNotification(id) { if (confirm('Are you sure?')) database.ref('notifications/' + id).remove().catch(err => alert(err.message)); }
    
    document.addEventListener('DOMContentLoaded', initializeApp);
    
    </script>          
</body>
</html>